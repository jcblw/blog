<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/favico.svg">
<meta name="generator" content="Astro v2.0.5">

<!-- Canonical URL -->
<link rel="canonical" href="https://jcbl.ws/love-war-augmenting-web/">

<!-- Primary Meta Tags -->
<title>In love and war, augmenting the web.</title>
<meta name="title" content="In love and war, augmenting the web.">
<meta name="description" content="How Toucan tries not to break your site.">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://jcbl.ws/love-war-augmenting-web/">
<meta property="og:title" content="In love and war, augmenting the web.">
<meta property="og:description" content="How Toucan tries not to break your site.">
<meta property="og:image" content="https://jcbl.ws/placeholder-social.jpg">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://jcbl.ws/love-war-augmenting-web/">
<meta property="twitter:title" content="In love and war, augmenting the web.">
<meta property="twitter:description" content="How Toucan tries not to break your site.">
<meta property="twitter:image" content="https://jcbl.ws/placeholder-social.jpg">

<!-- Styles -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true">
<link href="https://fonts.googleapis.com/css2?family=Inconsolata&#38;family=Oxygen:wght@300;400&#38;display=swap" rel="stylesheet">
		
	<link rel="stylesheet" href="/_astro/_...slug_.e1b8cc14.css" />
<link rel="stylesheet" href="/_astro/_...slug_.e6843b2e.css" />
<link rel="stylesheet" href="/_astro/_...slug_.592bcd50.css" /></head>

	<body class="astro-BVZIHDZO">
		<header class="container">
	<nav class="py--l flex items--center">
		<a href="/" class="h3 flex items--center justify--center pr--s py--xs no-underline color--link">
	jcblw
</a>
		<a href="/blog" class="flex items--center justify--center pr--s py--xs no-underline color--link">
	Blog
</a>
		<a href="/talks" class="flex items--center justify--center pr--s py--xs no-underline color--link">
	Talks
</a>
	</nav>
</header>
		<main class="relative astro-BVZIHDZO">
			<div class="flex items--center justify--center px--xs astro-BVZIHDZO">
				
			</div>
			
<aside class="sticky table-of-contents astro-XVRFUPWN">
  <div class="absolute top-0 bg--backgroundSecondary rounded--m py--xs px--m mt--m astro-XVRFUPWN">
    <details class="astro-XVRFUPWN">
    <summary class="astro-XVRFUPWN"><h5 class="inline-flex bold pb--xs pt--xs astro-XVRFUPWN">Sections</h5></summary>
    <p class="py--zero astro-XVRFUPWN"><a href="#html-headaches" class="astro-XVRFUPWN">HTML Headaches.</a></p><p class="py--zero astro-XVRFUPWN"><a href="#augmentation" class="astro-XVRFUPWN">Augmentation</a></p><p class="py--zero astro-XVRFUPWN"><a href="#im-going-to-need-a-reference" class="astro-XVRFUPWN">I’m going to need a reference</a></p><p class="py--zero astro-XVRFUPWN"><a href="#making-it-real" class="astro-XVRFUPWN">Making it real</a></p><p class="py--zero astro-XVRFUPWN"><a href="#its-all-in-the-details" class="astro-XVRFUPWN">It’s all in the details</a></p>
    </details>
  </div>
</aside>
			<section class="container astro-BVZIHDZO">
				<div class="author-section flex row items--center py--s px--m mt--m bg--backgroundSecondary rounded--xxl astro-BVZIHDZO">
					<img class="rounded--full flex--0 astro-BVZIHDZO" width="45px" height="45px" src="https://avatars1.githubusercontent.com/u/578259?s=460&#38;v=4" alt="Jacob Lowe">
					<div class="pl--s flex--1 astro-BVZIHDZO">
						<h6 class="color--overline pt--zero pb--xs bold astro-BVZIHDZO">Jacob Lowe</h6>
						<p class="py--zero published-at astro-BVZIHDZO">
  <span>Published  </span>
  <time datetime="2021-05-23T00:00:00.000Z">
    May 22, 2021
  </time>
  <span>  ●  6 min read </span>
</p>
					</div>
				</div>
			</section>
			<article class="container blog-post astro-BVZIHDZO">
				<h1 class="color--link astro-BVZIHDZO">In love and war, augmenting the web.</h1>
				<hr class="astro-BVZIHDZO">
				<h3 id="html-headaches"><a aria-hidden="true" tabIndex="-1" href="#html-headaches"><span class="heading-link">⌗</span></a>HTML Headaches.</h3>
<p>Bug, after bug report was coming to feedback channels it felt so overwhelming. This was an indication that we were doing something wrong, especially when we were breaking the functionality of other web pages. Toucan is meant to augment the web, but often we were breaking pieces of the web too. This often can happen with extensions, especially an extension that is supposed to work across the entire web replacing content. I like to believe that all these extension creators never have the intention of breaking other web pages, but we have the power to do that. Sadly sometimes even well-intentioned extensions break other pages.</p>
<p>I remember seeing some fixes make it into the codebase that was attempting to fix these issues. It seemed more like a game of a whack a mole to which the holes were webpages and a mole would pop up on one. This sometimes could be compounded because it depended on a version of a website. There needed to be a change, and I would like to talk about a major change we made to be a better collaborator with all the other developers on the web.</p>
<h3 id="augmentation"><a aria-hidden="true" tabIndex="-1" href="#augmentation"><span class="heading-link">⌗</span></a>Augmentation</h3>
<p>As a web extension, it’s easy to lose sight of how important it is to be a good collaborator with the other developers on the internet. Extensions, especially Toucan, seem to be in this augmented world above it all. Flying by and changing things we see fit. Past implementations of Toucan did a lot with the DOM. We used to take a string of HTML and shove it into the page. The level of destruction that this made was vast. On pages that were articles and just had content that was totally fine, but when you are on a page like Google Maps this because very apparent. Toucan was the aggressor in these situations. We would be taking people’s hard work and scramble their sites HTML. If Toucan was planning to work across the web we had to change. The code below had to go.</p>
<pre class="language-javascript"><code class="language-javascript">htmlElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
	Toucans are a &lt;a href=&quot;/fruit&quot;&gt;fruit&lt;/a&gt; eating &lt;span lang=&quot;es&quot;&gt;pájaro&lt;/span&gt;.
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre>
<p>There is a number of reasons why this piece of code is not great. Let’s kinda breeze over that there are tons of potential issues with reevaluating HTML and focus on what this means in a modern web stack and why this broke so much.</p>
<h3 id="im-going-to-need-a-reference"><a aria-hidden="true" tabIndex="-1" href="#im-going-to-need-a-reference"><span class="heading-link">⌗</span></a>I’m going to need a reference</h3>
<p>The code above that re-evaluates HTML is not only creating new DOM elements but also is now going to break references to any DOM elements that other programs have been holding. Like I mentioned above this is not a huge issue in articles. They solemnly need to have a reference to a span or anchor tag, but in a modern application that is not the case. Let’s say, hypothetically, that in the above replacement we were in a React application, that react application had some bindings on that anchor tag for the word fruit. Maybe the application shows a useful tooltip here or attached some smooth scrolling. This would all be broken in by this replacement due to the anchor tag now being a different element and all references being broken.</p>
<p>You may see how this can be an issue, imagine an extension going through your nice and neat code and breaking references to elements. This is what Toucan was doing, and there are still extensions out there doing the same thing. This method of replacement was breaking all kinds of things from tooltip, accordions, scrolling on maps, broken links. These breaks were not only frustrating for our users, but also for us. We essentially had to accommodate everyone’s code, coding style, and make sure that we did not interfere.</p>
<p>Now the question is how did we resolve this? This all comes down to one line of code.</p>
<pre class="language-javascript"><code class="language-javascript">textNode<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pre<span class="token punctuation">,</span> translation<span class="token punctuation">,</span> post<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This one line of code was a powerful realization for me for a number of reasons. The first was that I never really played around with text nodes, I always am focused on HTML elements. Not realizing there was a lot of depth to the API of a text node I was able to see that we did not need to touch HTML elements when replacing content. This is important because you can not attach interaction with text nodes, only HTML elements. That means that if we were to replace a text node there was no chance that a program was going to have event listeners attached to that node*. We would be able to replace content on the page, but that content would be something that would not break any functionality. Finally, a way to replace that would be light as a feather on these web pages.</p>
<h3 id="making-it-real"><a aria-hidden="true" tabIndex="-1" href="#making-it-real"><span class="heading-link">⌗</span></a>Making it real</h3>
<p>After figuring out that we could replace text nodes, there were a few other pieces to this rewrite that we needed to test out and make sure it was possible. These are things that are more relevant to Toucan, a React app inside a content script. Let’s just say we figured out the other big piece of this solution.</p>
<p>Another thing was that sure it was just replacing nodes on a page, but that was not just it. Our translation pipeline was creating HTML, parsing HTML, and worked based on HTML. We would need a set of utilities to be able to deal with this new HTML*-less* world. Before starting the project when experimenting with all this technology I started building up a set of tools into a library that I called Aracari. Aracari is just some simple tools to deal with text inside of DOM nodes. This tooling actually was super useful, it not only allows us to replace text the way you would do it in a string. Aracari also was able to make it so we could explore this data in areas to which we did not have to access the DOM. Overall a huge win for us.</p>
<p><a href="https://github.com/jointoucan/aracari">jointoucan/aracari</a></p>
<h3 id="its-all-in-the-details"><a aria-hidden="true" tabIndex="-1" href="#its-all-in-the-details"><span class="heading-link">⌗</span></a>It’s all in the details</h3>
<p>Now is our solution perfect? Not at all, I ran into many hurdles that I made some hacks for to make it work, but the key was that now we are not breaking our user’s experience. In other words, we were not completely breaking the web anymore. Looking back here are some things that I would like to handle more delicately and gracefully.</p>
<p>The biggest point of all this is, when building a web extension there are a lot of ways you can just break things. Being a good web citizen pays off whether through fewer bug tickets or greater satisfaction from your users.</p>
<hr/>
<p>Looking to learn a new language? Try out <a href="https://jointoucan.com">Toucan</a>.</p>
<p>*Now I do want to acknowledge that yes programs like React hold references to text nodes, that being said it does not break anything but some tracking of that text node.</p>
			</article>
			<section class="container astro-BVZIHDZO">
				<style>astro-island,astro-slot{display:contents}</style><script>(self.Astro=self.Astro||{}).only=t=>{(async()=>await(await t())())()},window.dispatchEvent(new Event("astro:only"));var l;{const c={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(JSON.parse(t)),9:t=>new Uint16Array(JSON.parse(t)),10:t=>new Uint32Array(JSON.parse(t))},o=(t,s)=>{if(t===""||!Array.isArray(s))return s;const[e,n]=s;return e in c?c[e](n):void 0};customElements.get("astro-island")||customElements.define("astro-island",(l=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{if(!this.hydrator||this.parentElement&&this.parentElement.closest("astro-island[ssr]"))return;const s=this.querySelectorAll("astro-slot"),e={},n=this.querySelectorAll("template[data-astro-template]");for(const r of n){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(const r of s){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("name")||"default"]=r.innerHTML)}const a=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,a,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((s,e)=>{e.disconnect(),this.childrenConnectedCallback()}).observe(this,{childList:!0})}async childrenConnectedCallback(){window.addEventListener("astro:hydrate",this.hydrate);let s=this.getAttribute("before-hydration-url");s&&await import(s),this.start()}start(){const s=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(Astro[e]===void 0){window.addEventListener(`astro:${e}`,()=>this.start(),{once:!0});return}Astro[e](async()=>{const n=this.getAttribute("renderer-url"),[a,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(const d of i.split("."))this.Component=this.Component[d]}return this.hydrator=r,this.hydrate},s,this)}attributeChangedCallback(){this.hydrator&&this.hydrate()}},l.observedAttributes=["props"],l))}</script><astro-island uid="7uNWa" component-url="/_astro/Comments.f3e8a87c.js" component-export="Comments" renderer-url="/_astro/client.38423ee9.js" props="{&quot;slug&quot;:[0,&quot;/love-war-augmenting-web&quot;],&quot;title&quot;:[0,&quot;In love and war, augmenting the web.&quot;],&quot;shortname&quot;:[0,&quot;jcbl-ws&quot;],&quot;class&quot;:[0,&quot;astro-BVZIHDZO&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;Comments&quot;,&quot;value&quot;:true}"></astro-island>
			</section>
			<div class="flex row container astro-BVZIHDZO">
				<a href="https://mobile.twitter.com/search?q=https://jcbl.ws/blog/love-war-augmenting-web" class="pr--l my--m  astro-BVZIHDZO">
					Discuss it on Twitter
				</a>
				<a href="https://github.com/jcblw/blog/src/content/blog/love-war-augmenting-web" class="pr--l my--m  astro-BVZIHDZO">
					Edit on Github
				</a>
			</div>
		</main>
		<footer class="container">
	<hr>
	<p class="pb--xxl">&copy; 2023 Jacob Lowe. All rights reserved.</p>
</footer>
	</body></html>