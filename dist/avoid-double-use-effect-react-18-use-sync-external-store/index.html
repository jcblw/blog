<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/favico.svg">
<meta name="generator" content="Astro v2.0.5">

<!-- Canonical URL -->
<link rel="canonical" href="https://jcbl.ws/avoid-double-use-effect-react-18-use-sync-external-store/">

<!-- Primary Meta Tags -->
<title>Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables</title>
<meta name="title" content="Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables">
<meta name="description" content="This blog will show you how I avoided double useEffect fetches in React 18 by migrating a library to use useSyncExternalStore and observables.">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://jcbl.ws/avoid-double-use-effect-react-18-use-sync-external-store/">
<meta property="og:title" content="Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables">
<meta property="og:description" content="This blog will show you how I avoided double useEffect fetches in React 18 by migrating a library to use useSyncExternalStore and observables.">
<meta property="og:image" content="https://jcbl.ws/placeholder-social.jpg">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://jcbl.ws/avoid-double-use-effect-react-18-use-sync-external-store/">
<meta property="twitter:title" content="Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables">
<meta property="twitter:description" content="This blog will show you how I avoided double useEffect fetches in React 18 by migrating a library to use useSyncExternalStore and observables.">
<meta property="twitter:image" content="https://jcbl.ws/placeholder-social.jpg">

<!-- Styles -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true">
<link href="https://fonts.googleapis.com/css2?family=Inconsolata&#38;family=Oxygen:wght@300;400&#38;display=swap" rel="stylesheet">
		
	<link rel="stylesheet" href="/_astro/_...slug_.e1b8cc14.css" />
<link rel="stylesheet" href="/_astro/_...slug_.e6843b2e.css" />
<link rel="stylesheet" href="/_astro/_...slug_.592bcd50.css" /></head>

	<body class="astro-BVZIHDZO">
		<header class="container">
	<nav class="py--l flex items--center">
		<a href="/" class="h3 flex items--center justify--center pr--s py--xs no-underline color--link">
	jcblw
</a>
		<a href="/blog" class="flex items--center justify--center pr--s py--xs no-underline color--link">
	Blog
</a>
		<a href="/talks" class="flex items--center justify--center pr--s py--xs no-underline color--link">
	Talks
</a>
	</nav>
</header>
		<main class="relative astro-BVZIHDZO">
			<div class="flex items--center justify--center px--xs astro-BVZIHDZO">
				<img src="/bullet-train.png" alt="Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables" class="hero-image rounded--m astro-BVZIHDZO">
			</div>
			
<aside class="sticky table-of-contents astro-XVRFUPWN">
  <div class="absolute top-0 bg--backgroundSecondary rounded--m py--xs px--m mt--m astro-XVRFUPWN">
    <details class="astro-XVRFUPWN">
    <summary class="astro-XVRFUPWN"><h5 class="inline-flex bold pb--xs pt--xs astro-XVRFUPWN">Sections</h5></summary>
    <p class="py--zero astro-XVRFUPWN"><a href="#the-problem-of-double-useeffect-calls" class="astro-XVRFUPWN">The problem of double “useEffect” calls</a></p><p class="py--zero astro-XVRFUPWN"><a href="#my-first-foray-with-react-18-and-strict-mode" class="astro-XVRFUPWN">My first foray with React 18 and strict mode</a></p><p class="py--zero astro-XVRFUPWN"><a href="#a-double-fetch-example" class="astro-XVRFUPWN">A double fetch example</a></p><p class="py--zero astro-XVRFUPWN"><a href="#migrating-fetches-to-observables-and-usesyncexternalstore" class="astro-XVRFUPWN">Migrating fetches to observables and useSyncExternalStore</a></p><p class="py--zero astro-XVRFUPWN"><a href="#conclusion" class="astro-XVRFUPWN">Conclusion</a></p>
    </details>
  </div>
</aside>
			<section class="container astro-BVZIHDZO">
				<div class="author-section flex row items--center py--s px--m mt--m bg--backgroundSecondary rounded--xxl astro-BVZIHDZO">
					<img class="rounded--full flex--0 astro-BVZIHDZO" width="45px" height="45px" src="https://avatars1.githubusercontent.com/u/578259?s=460&#38;v=4" alt="Jacob Lowe">
					<div class="pl--s flex--1 astro-BVZIHDZO">
						<h6 class="color--overline pt--zero pb--xs bold astro-BVZIHDZO">Jacob Lowe</h6>
						<p class="py--zero published-at astro-BVZIHDZO">
  <span>Published  </span>
  <time datetime="2023-01-29T00:00:00.000Z">
    Jan 28, 2023
  </time>
  <span>  ●  6 min read </span>
</p>
					</div>
				</div>
			</section>
			<article class="container blog-post astro-BVZIHDZO">
				<h1 class="color--link astro-BVZIHDZO">Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables</h1>
				<hr class="astro-BVZIHDZO">
				<h3 id="the-problem-of-double-useeffect-calls"><a aria-hidden="true" tabIndex="-1" href="#the-problem-of-double-useeffect-calls"><span class="heading-link">⌗</span></a>The problem of double “useEffect” calls</h3>
<p>The problem of double useEffect calls in React 18 is caused by a feature in React 18 called ”<a href="https://reactjs.org/docs/strict-mode.html">strict mode</a>,” which is a helpful tool that helps you catch issues in your code. This feature causes useEffect to run twice when there are zero dependencies. In prior versions of React, this is how you would run code on <a href="https://stackoverflow.com/questions/31556450/what-is-mounting-in-react-js">mount</a> of a component. This can lead to problems such as sending data fetching requests twice and double tracking page view events. This can cause unexpected behavior in your application.</p>
<p>You can turn off this feature by commenting out <code>&lt;React.StrictMode /&gt;</code> at the entry point, but this also turns off many of React’s useful strict checks. I recommend using this feature, it is another way that React helps you write idiomatic React code, but it is understandable if you want to turn it off.</p>
<h3 id="my-first-foray-with-react-18-and-strict-mode"><a aria-hidden="true" tabIndex="-1" href="#my-first-foray-with-react-18-and-strict-mode"><span class="heading-link">⌗</span></a>My first foray with React 18 and strict mode</h3>
<p>When upgrading to React 18, in my <a href="https://getmujo.com">Mujō Chrome Extension</a> codebase, I encountered a problem with double useEffect calls in my codebase. Specifically, all inter-process communication (IPC) was firing twice. After researching and experimenting, I discovered that the issue was caused by using an IPC request in an useEffect called twice.</p>
<p>To solve this issue, I introduced observables into my library, <a href="https://github.com/jcblw/finch-graphql">Finch GraphQL</a>, and updated my React component to listen to the <a href="https://en.wikipedia.org/wiki/Observer_pattern#:~:text=In%20software%20design%20and%20engineering,calling%20one%20of%20their%20methods.">observables</a> using the <a href="https://beta.reactjs.org/reference/react/useSyncExternalStore"><code>useSyncExternalStore</code></a> hook. This allowed me to synchronize my component’s local state with the external store and avoid the double useEffect calls.</p>
<p>Observables are a great way to get notified when data changes happen. In this case, I could hold on to requests and response data from IPC calls in this observable. Once having that data, it was straightforward to subscribe to those changes in a custom hook using <code>useSyncExternalStore.</code></p>
<h3 id="a-double-fetch-example"><a aria-hidden="true" tabIndex="-1" href="#a-double-fetch-example"><span class="heading-link">⌗</span></a>A double fetch example</h3>
<p>Before I go into the implementation of how I updated my code to avoid double useEffect calls successfully, I want to give a brief overview of how the code worked before. In this small example, I create an <code>useFetch</code> hook that fetches data from an API.</p>
<iframe src="https://codesandbox.io/embed/practical-dirac-p3zcxx?fontsize=14&#38;hidenavigation=1&#38;module=%2Fsrc%2FuseFetch.ts&#38;theme=dark" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" title="practical-dirac-p3zcxx" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; USB; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<p>In this example, you can see that I am fetching the data in the useEffect hook. This means that when you open up the console, you should see the use effect call happening twice and the API call happening twice. You can see it’s a relatively simple example, which is one of the reasons people use this pattern.</p>
<h3 id="migrating-fetches-to-observables-and-usesyncexternalstore"><a aria-hidden="true" tabIndex="-1" href="#migrating-fetches-to-observables-and-usesyncexternalstore"><span class="heading-link">⌗</span></a>Migrating fetches to observables and useSyncExternalStore</h3>
<p>I initially started with a library called <a href="https://rxjs.dev/">RxJS</a> to create observables, but I only needed a small amount of code to make a functioning observable. Having a small footprint, it is easier to comprehend how observers work. Here is what the observable looks like.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// See the full version in the codesandbox below</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observable<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">//The subscribe method allows for subscribing to changes in the observable value</span>
  <span class="token keyword">public</span> <span class="token function-variable function">subscribe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token comment">// This method allows for the getting of a snapshot of the current value</span>
  <span class="token keyword">public</span> <span class="token function-variable function">getSnapshot</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token comment">// This method allows for the updating of the observable value</span>
  <span class="token keyword">public</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Taking that implementation of an observable, I added it to my library—the shape of the data needed to be updated. In the observable, we need to store the loading state of the request. To make the cache aware if we were waiting for data. This update was vital because we didn’t want to make duplicate requests if we were already waiting for data.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// The data from the request</span>
  error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// The error from the request</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Now that we have this observable, we need to update the values based on the fetch loading state and response. This looks something like this.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// See the full version in the codesandbox below</span>
observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>snapshot<span class="token punctuation">,</span> <span class="token comment">// snapshot of data</span>
  loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>snapshot<span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>snapshot<span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> err<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Next, we need to hook the observable into the <code>useSyncExternalStore</code> hook to pull the data from the observable into the component. This looks something like this.</p>
<pre class="language-ts"><code class="language-ts"><span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>observable<span class="token punctuation">.</span>subscribe<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observable<span class="token punctuation">.</span>getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>There is one last thing we have to do to make this work. We need a way to look up the existing observable for a given request. In the example, I am just using the URL as the key, but in an actual application, you would want to use a more robust key. This is what the lookup looks like for the example.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Observable<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">useFetch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">URL</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> observable <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// check for the existing cache</span>
    <span class="token keyword">const</span> existingCache <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCache<span class="token punctuation">)</span> <span class="token keyword">return</span> existingCache

    <span class="token comment">// create a new observable, a fetch data</span>
    <span class="token keyword">const</span> newObservable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// a function that looks like the code above</span>
    <span class="token function">fetchURL</span><span class="token punctuation">(</span>newObservable<span class="token punctuation">,</span> <span class="token constant">URL</span><span class="token punctuation">)</span>
    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span> newObservable<span class="token punctuation">)</span>
    <span class="token keyword">return</span> newObservable
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">...</span></code></pre>
<p>After you put all of this together, you should have something like this.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// See the full version in the codesandbox below</span>
<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Observable<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fetchData <span class="token operator">=</span> <span class="token generic-function"><span class="token function">async</span> <span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> RequestInit<span class="token punctuation">,</span>
  observable<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>CacheShape<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> snapshot <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>snapshot<span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    observable<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>snapshot<span class="token punctuation">,</span>
      loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> error <span class="token keyword">as</span> Error<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useFetch <span class="token operator">=</span> <span class="token operator">&lt;</span>Data <span class="token keyword">extends</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> RequestInit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> observable <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> existingObservable <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> Observable<span class="token operator">&lt;</span>CacheShape<span class="token operator">&lt;</span>Data<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>existingObservable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newObservable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable<span class="token operator">&lt;</span>CacheShape<span class="token operator">&lt;</span>Data<span class="token operator">&gt;&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;fetching&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token generic-function"><span class="token function">fetchData</span><span class="token generic class-name"><span class="token operator">&lt;</span>Data<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> newObservable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">,</span> newObservable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> newObservable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> existingObservable<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>observable<span class="token punctuation">.</span>subscribe<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    observable<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Here is the complete example in a codesandbox.</p>
<iframe src="https://codesandbox.io/embed/happy-currying-g3stkz?fontsize=14&#38;hidenavigation=1&#38;module=%2Fsrc%2FuseFetch.ts&#38;theme=dark" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" title="happy-currying-g3stkz" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; USB; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<p>In the sandbox, you will see all the code above integrated, and you should be able to open the dev tools to see that the API is only called once. It may be more code that the useEffect example, but is a great pattern that can be applied to many different use cases.</p>
<h3 id="conclusion"><a aria-hidden="true" tabIndex="-1" href="#conclusion"><span class="heading-link">⌗</span></a>Conclusion</h3>
<p>By migrating to observables and using the useSyncExternalStore hook, I was able to avoid the double useEffect calls caused by strict mode in React 18. Not only did this solve the problem of double data fetching, but it also made my code more robust and maintainable. I highly recommend using observables and the useSyncExternalStore hook in your React applications, especially when dealing with external data sources.</p>
<p>You can see the full code of this example in this <a href="https://codesandbox.io/embed/happy-currying-g3stkz?fontsize=14&#38;hidenavigation=1&#38;module=%2Fsrc%2FuseFetch.ts&#38;theme=dark">codesandbox</a> and the updated version of my library <a href="https://github.com/jcblw/finch-graphql">Finch GraphQL</a> on GitHub.</p>
<p>I hope this blog post helps you avoid the double useEffect calls caused by strict mode in React 18 and shows you the benefits of using observables and the useSyncExternalStore hook in your React applications.</p>
			</article>
			<section class="container astro-BVZIHDZO">
				<style>astro-island,astro-slot{display:contents}</style><script>(self.Astro=self.Astro||{}).only=t=>{(async()=>await(await t())())()},window.dispatchEvent(new Event("astro:only"));var l;{const c={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(JSON.parse(t)),9:t=>new Uint16Array(JSON.parse(t)),10:t=>new Uint32Array(JSON.parse(t))},o=(t,s)=>{if(t===""||!Array.isArray(s))return s;const[e,n]=s;return e in c?c[e](n):void 0};customElements.get("astro-island")||customElements.define("astro-island",(l=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{if(!this.hydrator||this.parentElement&&this.parentElement.closest("astro-island[ssr]"))return;const s=this.querySelectorAll("astro-slot"),e={},n=this.querySelectorAll("template[data-astro-template]");for(const r of n){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(const r of s){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("name")||"default"]=r.innerHTML)}const a=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,a,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((s,e)=>{e.disconnect(),this.childrenConnectedCallback()}).observe(this,{childList:!0})}async childrenConnectedCallback(){window.addEventListener("astro:hydrate",this.hydrate);let s=this.getAttribute("before-hydration-url");s&&await import(s),this.start()}start(){const s=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(Astro[e]===void 0){window.addEventListener(`astro:${e}`,()=>this.start(),{once:!0});return}Astro[e](async()=>{const n=this.getAttribute("renderer-url"),[a,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(const d of i.split("."))this.Component=this.Component[d]}return this.hydrator=r,this.hydrate},s,this)}attributeChangedCallback(){this.hydrator&&this.hydrate()}},l.observedAttributes=["props"],l))}</script><astro-island uid="mJNar" component-url="/_astro/Comments.f3e8a87c.js" component-export="Comments" renderer-url="/_astro/client.38423ee9.js" props="{&quot;slug&quot;:[0,&quot;/avoid-double-use-effect-react-18-use-sync-external-store&quot;],&quot;title&quot;:[0,&quot;Avoiding useEffect for fetching in React 18: A use-case for useSyncExternalStore and Observables&quot;],&quot;shortname&quot;:[0,&quot;jcbl-ws&quot;],&quot;class&quot;:[0,&quot;astro-BVZIHDZO&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;Comments&quot;,&quot;value&quot;:true}"></astro-island>
			</section>
			<div class="flex row container astro-BVZIHDZO">
				<a href="https://mobile.twitter.com/search?q=https://jcbl.ws/blog/avoid-double-use-effect-react-18-use-sync-external-store" class="pr--l my--m  astro-BVZIHDZO">
					Discuss it on Twitter
				</a>
				<a href="https://github.com/jcblw/blog/src/content/blog/avoid-double-use-effect-react-18-use-sync-external-store" class="pr--l my--m  astro-BVZIHDZO">
					Edit on Github
				</a>
			</div>
		</main>
		<footer class="container">
	<hr>
	<p class="pb--xxl">&copy; 2023 Jacob Lowe. All rights reserved.</p>
</footer>
	</body></html>